name: Report Service CI

on:
  push:
    branches: [main, feat/report, dev]
    paths:
      - 'src/services/report/**'
      - '.github/workflows/report-service.yml'
  pull_request:
    branches: [main, dev]
    paths:
      - 'src/services/report/**'

env:
  MIX_ENV: test
  ELIXIR_VERSION: '1.15'
  OTP_VERSION: '26'

jobs:
  # ==========================================================================
  # Job 1: Compile Check
  # ==========================================================================
  compile:
    name: Compile Check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: src/services/report

    steps:
      - uses: actions/checkout@v4

      - name: Set up Elixir
        uses: erlef/setup-beam@v1
        with:
          elixir-version: ${{ env.ELIXIR_VERSION }}
          otp-version: ${{ env.OTP_VERSION }}

      - name: Cache deps
        uses: actions/cache@v4
        with:
          path: |
            src/services/report/deps
            src/services/report/_build
          key: ${{ runner.os }}-mix-${{ hashFiles('src/services/report/mix.lock') }}
          restore-keys: |
            ${{ runner.os }}-mix-

      - name: Install dependencies
        run: mix deps.get

      - name: Compile with warnings as errors
        run: mix compile --warnings-as-errors

      - name: Check formatting
        run: mix format --check-formatted

  # ==========================================================================
  # Job 2: Static Analysis
  # ==========================================================================
  static-analysis:
    name: Static Analysis (Credo)
    runs-on: ubuntu-latest
    needs: compile
    defaults:
      run:
        working-directory: src/services/report

    steps:
      - uses: actions/checkout@v4

      - name: Set up Elixir
        uses: erlef/setup-beam@v1
        with:
          elixir-version: ${{ env.ELIXIR_VERSION }}
          otp-version: ${{ env.OTP_VERSION }}

      - name: Cache deps
        uses: actions/cache@v4
        with:
          path: |
            src/services/report/deps
            src/services/report/_build
          key: ${{ runner.os }}-mix-${{ hashFiles('src/services/report/mix.lock') }}

      - name: Install dependencies
        run: mix deps.get

      - name: Run Credo
        run: mix credo --strict || true

  # ==========================================================================
  # Job 3: Unit Tests (without DB)
  # ==========================================================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: compile
    defaults:
      run:
        working-directory: src/services/report

    services:
      cockroachdb:
        image: cockroachdb/cockroach:latest
        ports:
          - 26257:26257
        options: >-
          --health-cmd "curl -f http://localhost:8080/health || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        env:
          COCKROACH_DATABASE: report_test

    steps:
      - uses: actions/checkout@v4

      - name: Set up Elixir
        uses: erlef/setup-beam@v1
        with:
          elixir-version: ${{ env.ELIXIR_VERSION }}
          otp-version: ${{ env.OTP_VERSION }}

      - name: Cache deps
        uses: actions/cache@v4
        with:
          path: |
            src/services/report/deps
            src/services/report/_build
          key: ${{ runner.os }}-mix-${{ hashFiles('src/services/report/mix.lock') }}

      - name: Install dependencies
        run: mix deps.get

      - name: Wait for CockroachDB
        run: |
          for i in {1..30}; do
            if curl -f http://localhost:8080/health; then
              echo "CockroachDB is ready!"
              break
            fi
            echo "Waiting for CockroachDB... ($i/30)"
            sleep 2
          done

      - name: Setup test database
        run: |
          mix ecto.create
          mix ecto.migrate
        env:
          DB_HOST: localhost
          DB_PORT: 26257
          DB_NAME: report_test
          DB_USER: root
          DB_PASSWORD: ""

      - name: Run tests
        run: mix test --trace
        env:
          DB_HOST: localhost
          DB_PORT: 26257
          DB_NAME: report_test
          DB_USER: root
          DB_PASSWORD: ""
          NATS_ENABLED: false

  # ==========================================================================
  # Job 4: Integration Tests (with CockroachDB + NATS)
  # ==========================================================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: compile
    defaults:
      run:
        working-directory: src/services/report

    services:
      cockroachdb:
        image: cockroachdb/cockroach:latest
        ports:
          - 26257:26257
        options: >-
          --health-cmd "curl -f http://localhost:8080/health || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      nats:
        image: nats:alpine
        ports:
          - 4222:4222

    steps:
      - uses: actions/checkout@v4

      - name: Set up Elixir
        uses: erlef/setup-beam@v1
        with:
          elixir-version: ${{ env.ELIXIR_VERSION }}
          otp-version: ${{ env.OTP_VERSION }}

      - name: Cache deps
        uses: actions/cache@v4
        with:
          path: |
            src/services/report/deps
            src/services/report/_build
          key: ${{ runner.os }}-mix-${{ hashFiles('src/services/report/mix.lock') }}

      - name: Install dependencies
        run: mix deps.get

      - name: Wait for services
        run: |
          echo "Waiting for CockroachDB..."
          for i in {1..30}; do
            if curl -f http://localhost:8080/health; then
              echo "CockroachDB ready!"
              break
            fi
            sleep 2
          done
          
          echo "Waiting for NATS..."
          for i in {1..30}; do
            if nc -z localhost 4222; then
              echo "NATS ready!"
              break
            fi
            sleep 2
          done

      - name: Setup database
        run: |
          mix ecto.create
          mix ecto.migrate
        env:
          DB_HOST: localhost
          DB_PORT: 26257
          DB_NAME: report_test
          DB_USER: root
          DB_PASSWORD: ""

      - name: Run integration tests
        run: mix test --include integration --trace
        env:
          DB_HOST: localhost
          DB_PORT: 26257
          DB_NAME: report_test
          DB_USER: root
          DB_PASSWORD: ""
          NATS_URL: nats://localhost:4222

  # ==========================================================================
  # Job 5: Docker Runtime Test
  # ==========================================================================
  docker-runtime:
    name: Docker Runtime Test
    runs-on: ubuntu-latest
    needs: [unit-tests]

    steps:
      - uses: actions/checkout@v4

      - name: Setup certificates
        run: |
          mkdir -p certs
          # Generate dummy cert for testing
          openssl rand -base64 32 > certs/aes-256.key
          chmod 600 certs/aes-256.key

      - name: Build Docker image
        run: |
          docker build -t report-service:test ./src/services/report

      - name: Start minimal services
        run: |
          # Start only essential services for smoke test
          docker compose up -d db mb
          sleep 20

      - name: Start report service
        run: |
          docker compose up -d report-service
          sleep 15

      - name: Check service health
        run: |
          for i in {1..30}; do
            if curl -sf http://localhost:8000/reports/health | grep -q "ok"; then
              echo "Health check passed!"
              exit 0
            fi
            echo "Waiting for service... ($i/30)"
            docker compose logs report-service | tail -20
            sleep 2
          done
          echo "Health check failed!"
          docker compose logs report-service
          exit 1

      - name: Test API endpoints
        run: |
          echo "Testing GET /health..."
          curl -f http://localhost:8000/reports/health
          
          echo ""
          echo "Testing GET /metrics..."
          curl -sf http://localhost:8000/reports/metrics | head -20
          
          echo ""
          echo "Testing GET /api/reports/public (no auth)..."
          curl -f http://localhost:8000/reports/api/reports/public
          
          echo ""
          echo "Testing POST /api/reports (create public report)..."
          curl -f -X POST http://localhost:8000/reports/api/reports \
            -H "Content-Type: application/json" \
            -d '{"category": "sampah", "content": "CI test", "privacy_level": "public", "authority_department": "kebersihan", "status": "submitted"}'
          
          echo ""
          echo "Testing POST /api/reports (create private report)..."
          RESPONSE=$(curl -s -X POST http://localhost:8000/reports/api/reports \
            -H "Content-Type: application/json" \
            -d '{"category": "keamanan", "content": "Private CI test", "privacy_level": "private", "authority_department": "keamanan", "status": "submitted", "reporter_id": "test-123"}')
          echo "$RESPONSE"
          
          # Extract access token and test tracking
          ACCESS_TOKEN=$(echo "$RESPONSE" | jq -r '.data.access_token')
          if [ "$ACCESS_TOKEN" != "null" ]; then
            echo ""
            echo "Testing GET /api/reports/track/{token}..."
            curl -f "http://localhost:8000/reports/api/reports/track/$ACCESS_TOKEN"
          fi
          
          echo ""
          echo "All API tests passed!"

      - name: Cleanup
        if: always()
        run: |
          docker compose down -v
          rm -rf certs/